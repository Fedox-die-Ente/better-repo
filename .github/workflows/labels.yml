name: Setup Repository Labels

on:
  push:
    branches:
      - master

jobs:
  setup-labels:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Detect initial commit
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { data: commits } = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 2
            });
            if (commits.length === 1) {
              console.log("Initial commit detected.");
              return true;
            } else {
              console.log("Not the initial commit. Skipping.");
              return false;
            }

      - name: Setup labels
        if: steps.check.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const existingLabels = await github.rest.issues.listLabelsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            for (const label of existingLabels.data) {
              await github.rest.issues.deleteLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: label.name
              });
            }

            const labels = [
              {"name": "üî¨ research", "color": "ededed", "description": "Research needed"},
              {"name": "‚öôÔ∏è ops", "color": "c2e0c6", "description": "Ops task"},
              {"name": "ü§ñ ci", "color": "bfdadc", "description": "Related to GitHub Actions / CI"},
              {"name": "üé¨ demo", "color": "bfdadc", "description": "Demo label"},
              {"name": "üêû bug", "color": "d73a4a", "description": "Bug report"},
              {"name": "‚ú® enhancement", "color": "a2eeef", "description": "Feature request / enhancement"},
              {"name": "üìö documentation", "color": "0075ca", "description": "Documentation update"},
              {"name": "‚ùì question", "color": "d876e3", "description": "User question or inquiry"},
              {"name": "üôã help wanted", "color": "008672", "description": "Needs help from contributors"},
              {"name": "üå± good first issue", "color": "7057ff", "description": "Good entry point for new contributors"},
              {"name": "üö´ wontfix", "color": "ffffff", "description": "Issue won't be fixed"},
              {"name": "üîÅ duplicate", "color": "cccccc", "description": "Duplicate issue"},
              {"name": "‚ùå invalid", "color": "e6e6e6", "description": "Invalid issue or PR"},
              {"name": "‚è≥ in progress", "color": "fbca04", "description": "Work in progress"},
              {"name": "‚úÖ ready for review", "color": "0e8a16", "description": "PR ready for review"},
              {"name": "‚õî blocked", "color": "5319e7", "description": "Work is blocked"},
              {"name": "üî• priority: high", "color": "b60205", "description": "High priority"},
              {"name": "‚ö° priority: medium", "color": "d93f0b", "description": "Medium priority"},
              {"name": "üçÉ priority: low", "color": "0e8a16", "description": "Low priority"}
            ];

            for (const label of labels) {
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: label.name,
                description: label.description,
                color: label.color
              });
            }

      - name: Delete workflow after run
        if: steps.check.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const path = '.github/workflows/labels.yml';
            const { data: file } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path
            });
            await github.rest.repos.deleteFile({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path,
              message: 'Remove setup labels workflow after initial run',
              sha: file.sha
            });
